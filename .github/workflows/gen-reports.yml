name: Generate reports

on:
  push:
    branches:
    - master

  schedule:
   - cron: '0 */6 * * *'

jobs:
  generante-reports:
    name: Generate reports
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        jobset:
        - 'nixpkgs trunk'
        - 'nixpkgs nixpkgs-unstable-aarch64-darwin'
        - 'nixpkgs nixpkgs-21.11-darwin'
        - 'nixpkgs staging-next'
        - 'nixos trunk-combined'
        - 'nixos release-21.11'
        - 'nixos release-21.11-aarch64'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: master

    - name: Install Nix
      uses: cachix/install-nix-action@v16
      with:
        extra_nix_config: |
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    - name: Setup Cachix
      uses: cachix/cachix-action@v10
      with:
        name: malo
        signingKey: ${{ secrets.CACHIX_SIGNING_KEY }}

    - name: Get jobset eval IDs
      id: get-jobset-ids
      env:
        JOBSET: ${{ matrix.jobset }}
      run: |
        echo "::set-output name=id::$(nix run .#jobset-latest-eval-id -- $JOBSET)"
        echo "::set-output name=success-id::$(nix run .#jobset-latest-successful-eval-id -- $JOBSET)"

    - name: Get cache
      uses: actions/cache@v2
      id: cache
      with:
        path: data
        key: ${{ matrix.jobset }}-${{ steps.get-jobset-ids.outputs.success-id }}-${{ steps.get-jobset-ids.outputs.id }}-
        restore-keys: |
          ${{ matrix.jobset }}-${{ steps.get-jobset-ids.outputs.success-id }}-
          ${{ matrix.jobset }}-

    - name: Generate report
      if: steps.get-jobset-ids.outputs.success-id != steps.get-jobset-ids.outputs.id || steps.cache.outputs.cache-hit != 'true'
      env:
        JOBSET: ${{ matrix.jobset }}
      run: |
        nix run . -- $JOBSET

    - name: Push new/updated report
      if: steps.get-jobset-ids.outputs.success-id != steps.get-jobset-ids.outputs.id || steps.cache.outputs.cache-hit != 'true'
      env:
        JOBSET: ${{ matrix.jobset }}
        EVAL: ${{ steps.get-jobset-ids.outputs.id }}
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add --all
        git commit -m "Add/update $JOBSET report for eval $EVAL"
        git push
