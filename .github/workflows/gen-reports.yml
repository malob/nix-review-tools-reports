name: Generate reports

on:
  push:
    branches:
    - master

  schedule:
   - cron: '0 */6 * * *'

jobs:
  generante-reports:
    name: Generate reports
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        jobset:
        - 'nixpkgs trunk'
        - 'nixpkgs nixpkgs-unstable-aarch64-darwin'
        - 'nixpkgs nixpkgs-21.11-darwin'
        - 'nixpkgs staging-next'
        - 'nixos trunk-combined'
        - 'nixos release-21.11'
        - 'nixos release-21.11-aarch64'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: master

    - name: Install Nix
      uses: cachix/install-nix-action@v16
      with:
        extra_nix_config: |
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    - name: Setup Cachix
      uses: cachix/cachix-action@v10
      with:
        name: malo
        signingKey: ${{ secrets.CACHIX_SIGNING_KEY }}

    - name: Get latest eval ID for ${{ matrix.jobset }}
      id: get-jobset-id
      env:
        JOBSET: ${{ matrix.jobset }}
      run: |
        echo "::set-output name=jobset-id::$(nix run .#jobset-latest-eval-id -- $JOBSET)"

    - uses: actions/cache@v2
      id: cache
      with:
        path: data
        key: ${{ matrix.jobset }}-${{ steps.get-jobset-id.outputs.jobset-id }}
        restore-keys: |
          ${{ matrix.jobset }}-

    - name: Generate ${{ matrix.jobset }} report
      if: steps.cache.outputs.cache-hit != 'true'
      env:
        JOBSET: ${{ matrix.jobset }}
      run: |
        nix run . -- $JOBSET

    - name: Push updated report
      if: steps.cache.outputs.cache-hit != 'true'
      env:
        JOBSET: ${{ matrix.jobset }}
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add --all
        git commit -m "Update $JOBSET report"
        git push
